{% extends "../../layouts/govuk.njk" %}
{% from "govuk-frontend/govuk/components/input/macro.njk" import govukInput %}
{% from "govuk-frontend/govuk/components/button/macro.njk" import govukButton %}
{% from "govuk-frontend/govuk/components/panel/macro.njk" import govukPanel %}
{% from "govuk-frontend/govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk-frontend/govuk/components/table/macro.njk" import govukTable %}
{% from "govuk-frontend/govuk/components/select/macro.njk" import govukSelect %}

{% block pageTitle %}
  Statement
{% endblock %}

{% block content %}
  {{ super() }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-l paas-billing-heading">
        Monthly billing statement
      </h1>
    </div>

    <div class="govuk-grid-column-full">
      <form method="get" action="{{ linkTo('admin.statement.dispatcher', {organizationGUID: organization.metadata.guid}) }}" class="paas-statement-range">
        <input type="hidden" name="_csrf" value="{{ context.csrf }}" />
        <table class="govuk-table paas-statement-filters">
          <tbody class="govuk-table__body">
            <tr class="govuk-table__row">
              <th class="govuk-table__header" scope="column">
                Month
              </th>
              <th class="govuk-table__header" scope="column">
                Spaces
              </th>
              <th class="govuk-table__header" scope="column">
                Services and apps
              </th>
              <th class="govuk-table__header paas-hidden-table-header" scope="column">
                Filter
              </th>
            </tr>
            <tr>
              <td class="govuk-table__cell">
                <select class="govuk-select govuk-!-width-full" id="rangeStart" name="rangeStart">
                  {% for rangeStart, rangeTitle in listOfPastYearMonths %}
                    <option value="{{ rangeStart }}" {% if filterMonth == rangeStart  %}selected{% endif %}>{{ rangeTitle }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="govuk-table__cell">
                <select class="govuk-select govuk-!-width-full" id="space" name="space">
                  {% for space in spaces %}
                    <option value="{{ space.guid }}" {% if filterSpace.guid == space.guid %}selected{% endif %}> {{ space.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="govuk-table__cell">
                <select class="govuk-select govuk-!-width-full" id="service" name="service">
                  {% for plan in plans %}
                    <option value="{{ plan.guid }}" {% if filterService.guid == plan.guid %}selected{% endif %}>{{ plan.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="govuk-table__cell paas-statement-filter">
                {{ govukButton({text: "Filter", preventDoubleClick: true}) }}
              </td>
            </tr>
          </tbody>
        </table>

        <input type="hidden" name="sort" value="{{ orderBy }}" />
        <input type="hidden" name="order" value="{{ orderDirection }}" />
      </form>
    </div>

    <div class="govuk-grid-column-full">
      <table class="govuk-table paas-exchange-rate">
        <tr class="govuk-table__row">
          <th class="govuk-table__header" scope="row">
            Total cost for {{ currentMonth }}
            {% if filterSpace.metadata.guid != "none" %}
              <span class="paas-text-regular">in <strong>{{ filterSpace.entity.name | lower }}</strong> space</span>
            {% endif %}
            {% if filterService.metadata.guid != "none" %}
              <span class="paas-text-regular">with <strong>{{ filterService.entity.name | lower }}</strong> services</span>
            {% endif %}
          </th>
          <th class="paas-month-price paas-month-price-demphasised">
            &pound;{{ (totals.exVAT + (totals.exVAT * adminFee))  | currency(2) }}
          </th>
          <th class="paas-month-price">
            &pound;{{ (totals.incVAT + (totals.incVAT * adminFee)) | currency(2) }}
          </th>
        </tr>
        <tr>
          <td class="govuk-table__cell">
            <small>Included 10% admin fee:</small>
          </td>
          <td class="paas-month-price"><small>&pound;{{ (totals.exVAT * adminFee) | currency(2) }}</small></td>
          <td td class="paas-month-price"><small>&pound;{{ (totals.incVAT * adminFee) | currency(2) }}</small></td>
        </tr>
        <tr class="paas-month-total-information">
          {% if usdCurrencyRates.length == 1 %}
            <td class="govuk-table__cell">
              Exchange rate: &pound;1 to &dollar;{{1.0 / usdCurrencyRates[0].rate | currency(2)}}
            </td>
          {% elif usdCurrencyRates.length > 1 %}
            <td class="govuk-table__cell">
              Exchange rates:
              {% set comma = joiner() %}
              {% for usdCurrencyRate in usdCurrencyRates %}
                {{ comma() }}
                &pound;1 to &dollar;{{1.0 / usdCurrencyRate.rate | currency(2)}} from {{usdCurrencyRate.validFrom.toISOString().replace('T00:00:00.000Z', '') }}
              {% endfor %}
            </td>
          {% endif %}
          <td class="paas-month-price">ex VAT</td>
          <td td class="paas-month-price">inc VAT at 20&percnt;</td>
        </tr>
      </table>

      <p>
        <a href="{{ linkTo('admin.statement.download', {organizationGUID: organization.metadata.guid, rangeStart: filterMonth}) }}" class="govuk-link download">
          Download a spreadsheet of these items
        </a>
      </p>
    </div>
  </div>

  {% if items | length %}
    {% if isCurrentMonth %}
      <p class="paas-table-notification">
        This statement shows up to date provisional usage data for current month.
      </p>
    {% endif %}
    <form method="get" action="{{ linkTo('admin.statement.dispatcher', {organizationGUID: organization.metadata.guid}) }}" class="paas-statement-range">
      <input type="hidden" name="_csrf" value="{{ context.csrf }}" />
      <input type="hidden" name="rangeStart" value="{{ filterMonth }}" />
      <input type="hidden" name="space" value="{{ filterSpace.metadata.guid }}" />
      <input type="hidden" name="service" value="{{ filterService.metadata.guid }}" />

      <table class="govuk-table paas-table-billing-statement">
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            {% if orderDirection == "asc" %}
              {% set newOrder = "desc" %}
            {% else %}
              {% set newOrder = "asc" %}
            {% endif %}
            <th class="govuk-table__header" scope="col">
              {% if orderBy == "name" %}
                <input type="hidden" name="order" value="{{ newOrder }}">
              {% endif %}
              <button type="submit" name="sort" value="name" class="govuk-button filter-header {{ orderDirection if orderBy == 'name' }}">Name</button>
            </th>
            <th class="govuk-table__header" scope="col">
              {% if orderBy == "space" %}
                <input type="hidden" name="order" value="{{ newOrder }}">
              {% endif %}
              <button type="submit" name="sort" value="space" class="govuk-button filter-header {{ orderDirection if orderBy == 'space' }}">Space</button>
            </th>
            <th class="govuk-table__header" scope="col">
              {% if orderBy == "plan" %}
                <input type="hidden" name="order" value="{{ newOrder }}">
              {% endif %}
              <button type="submit" name="sort" value="plan" class="govuk-button filter-header {{ orderDirection if orderBy == 'plan' }}">Plan</button>
            </th>
            <th class="govuk-table__header" scope="col" style="text-align: right">Ex VAT</th>
            <th class="govuk-table__header" scope="col" style="text-align: right">
              {% if orderBy == "amount" %}
                <input type="hidden" name="order" value="{{ newOrder }}">
              {% endif %}
              <button type="submit" name="sort" value="amount" class="govuk-button filter-header {{ orderDirection if orderBy == 'amount' }}">Inc VAT</button>
            </th>
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          {% for item in items %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell ">
                {{ item.resourceName }}
              </td>
              <td class="govuk-table__cell ">
                {{ item.spaceName or item.spaceGUID }}
              </td>
              <td class="govuk-table__cell ">
                {{ item.planName }}
              </td>
              <td class="govuk-table__cell" style="text-align: right">
                <span class="currency">&pound;</span>
                {{ item.price.exVAT | currency(2) }}
              </td>
              <td class="govuk-table__cell" style="text-align: right">
                <span class="currency">&pound;</span>
                {{ item.price.incVAT | currency(2) }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </form>
  {% else %}
    <p class="paas-table-notification">There is no record of any usage for that period.</p>
  {% endif %}

{% endblock %}
